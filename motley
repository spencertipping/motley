#!/bin/bash
# https://github.com/spencertipping/motley
# MIT license

MOTLEY_MODES=
MOTLEY_COMMANDS=
MOTLEY_MODULES=
MOTLEY_MACHINES=

MOTLEY_SELF=$(hostname)

# Core functions
motley_defmodule() {
  MOTLEY_MODULES="$MOTLEY_MODULES $1"
  eval "MOTLEY_MODULE_DOC_$1=\"\$(cat)\""
}

motley_defmode() {
  for m; do
    MOTLEY_MODES="$MOTLEY_MODES $m"
    eval "motley_${m}_init() { :; }
          motley_${m}_end()  { :; }
          motley_${m}_machine() {
            local machine_key=\$1
            local machine=\$2
            local cmd=\$3
            shift 3
            motley_\$cmd \"\$machine_key\" \"\$machine\" $m \"\$@\"
          }"
  done
}

# Machine definition function
machine() {
  local machine=$1
  local machine_key=${machine//[^A-Za-z0-9]/_}
  shift
  MOTLEY_MACHINES="$MOTLEY_MACHINES $machine"
  eval "$machine_key() {
    motley_\${MOTLEY_MODE}_machine \"$machine_key\" \"$machine\" \"\$@\"
  }"

  while (( $# )); do
    motley_machine_meta_$1 "$machine_key" "$machine" "$2"
    shift 2
  done
}

# Informational modes (these bypass the Motfile)
motley_defmode modes modules

motley_modes_init() {
  echo "available modes:"
  for m in $MOTLEY_MODES; do
    echo "- $m"
  done
  exit 0
}

motley_modules_init() {
  echo "available modules:"
  for m in $MOTLEY_MODULES; do
    echo "- $m"
  done
  exit 0
}

# Core operative modes
motley_defmode machines ls
motley_defmode conf start stop status run

motley_machines_end() {
  for m in $MOTLEY_MACHINES; do
    echo $m
  done
}

motley_ls_machine() {
  shift
  echo "$@"
}

# Command definitions
motley_defcommand() {
  for c; do
    MOTLEY_COMMANDS="$MOTLEY_COMMANDS $c"
    eval "motley_${c}_init() { :; }
          motley_${c}()      { :; }
          motley_${c}_end()  { :; }"
  done
}

# Main argument processing
# First load any motley modules.
for m in "$(dirname "$0")"/motley-* ~/.motley.d/motley-*; do
  [[ -r "$m" ]] && source "$m"
done

# Now decide which motfile we're using and cd there.
MOTLEY_MOTFILE=Motfile
while [[ ${1#-} != $1 ]]; do
  case $1 in
    -f)
      MOTLEY_MOTFILE=$2
      shift 2
      ;;

    # Help about a module or general usage
    -h)
      if [[ -n "$2" ]]; then
        {
          eval "echo \"\$MOTLEY_MODULE_DOC_$2\""
          echo
        } >&2
      else
        {
          echo "motley usage:"
          echo "  motley [-f /path/to/Motfile] mode [args...]"
          echo "  motley -h [topic]"
          echo
          echo "where modes are"
          for m in $MOTLEY_MODES; do
            echo "- $m"
          done
          echo
          echo "help topics (motley -h topic):"
          for m in $MOTLEY_MODULES; do
            echo "- $m"
          done | sort
          echo
        } >&2
      fi
      exit 0
      ;;

    *)
      echo "motley: unrecognized option $1 (try -h for help)" 1>&2
      exit 1
      ;;
  esac
done

cd "$(dirname "$MOTLEY_MOTFILE")"

# Load any more modules in the motfile directory.
for m in motley-*; do
  [[ -r "$m" ]] && source "$m"
done

# Now set the mode based on command-line arguments, initialize modes, source
# the motfile, and end modes.
MOTLEY_MODE=${1:-ls}
shift
MOTLEY_ARGS=( "$@" )

motley_${MOTLEY_MODE}_init
for c in $MOTLEY_COMMANDS; do
  motley_${c}_init $MOTLEY_MODE
done

if [[ -r "$MOTLEY_MOTFILE" ]]; then
  source "$MOTLEY_MOTFILE"
else
  echo "motley: no Motfile present (try motley -h for help)" >&2
fi

motley_${MOTLEY_MODE}_end
for c in $MOTLEY_COMMANDS; do
  motley_${c}_end $MOTLEY_MODE
done
